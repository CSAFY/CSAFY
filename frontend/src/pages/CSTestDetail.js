import React, { useEffect, useState } from 'react';
import { defaultAPI } from '../utils/api';
import { useLocation, useNavigate, useParams } from 'react-router-dom';
import axios from 'axios';

// RECOIL
import { useRecoilState, useRecoilValue, useSetRecoilState } from 'recoil';
import { Token } from '../recoils/Token';
import { Count } from '../recoils/Count';
import {
  ChoiceArray,
  Right1Count,
  Right2Count,
  Right3Count,
  Right4Count,
  Right5Count,
  Right6Count,
  TestArray,
  ReviewNote,
} from '../recoils/TestData';

// COMPONENTS
import Progress from '../components/Progress';

// STYLED
import styled from 'styled-components';
import Choices from '../components/Choices';
import SpentTime from './SpentTime';
// import Temp from '../components/Temp';
// import swal from 'sweetalert2';

const TestDetailWrapper = styled.div`
  width: 100%;
  // height: 1200px;
  height: 100vh;

  display: flex;
  flex-direction: column;
  align-items: center;

  background-color: #f6f7fb;
`;
const TestDetailContent = styled.div`
  width: 1232px;

  position: relative;
`;
const DetailBox = styled.div`
  width: 543px;
  height: 180px;
  border-radius: 9px;
  box-shadow: 0 0 11px 1px rgba(0, 142, 208, 0.12);
  background-color: #fff;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  position: absolute;
  top: 135px;
  left: 50%;
  transform: translate(-50%);
`;
const Content = styled.div`
  font-size: 18px;
  font-weight: 600;

  text-align: center;
`;
const TypeButton = styled.div`
  width: 166px;
  height: 44px;
  border-radius: 60px;
  border: solid 1px #008ed0;
  background-color: #fff;
  font-size: 18px;
  font-weight: 600;

  &:hover {
    background-color: #008ed0;
    box-shadow: 0 0 15px 0 rgba(0, 142, 208, 0.3);
    color: #fff;
    // transform: scale(1.05);
  }

  display: flex;
  justify-content: center;
  align-items: center;

  cursor: pointer;
`;
const QuestionBox = styled.div`
  width: 543px;
  height: 180px;
  border-radius: 9px;
  box-shadow: 0 0 11px 1px rgba(0, 142, 208, 0.12);
  background-color: #fff;
  font-size: 18px;
  font-weight: 600;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  // position: absolute;
  // top: 249px;
  // left: 50%;
  // transform: translate(-50%);
`;
const TestList = styled.div`
  width: 70%;
  position: absolute;
  top: 50px;
  left: 50%;
  transform: translate(-50%);
`;

const SubmitButton = styled.div`
  width: 305px;
  height: 56px;
  border-radius: 77px;
  font-size: 18px;
  font-weight: 600;
  // background-color: #008ed0;
  // color: #fff;
  background-color: #fff;
  color: #000;
  box-shadow: 0 0 15px 0 rgba(0, 0, 0, 0.3);

  &:hover {
    background-color: #008ed0;
    box-shadow: 0 0 15px 0 rgba(0, 142, 208, 0.3);
    color: #fff;
    // transform: scale(1.05);
  }

  display: flex;
  justify-content: center;
  align-items: center;

  cursor: pointer;

  position: absolute;
  left: 50%;
  transform: translate(-50%);
`;

const TimerBox = styled.div`
  position: absolute;
  top: 100px;
  left: 200px;
`;

function CSTestDetail() {
  const navigate = useNavigate();
  const { testTitle } = useParams();
  const { state } = useLocation();
  // Recoil
  const token = useRecoilValue(Token);
  const setCount = useSetRecoilState(Count);
  const setChoiceArray = useSetRecoilState(ChoiceArray);
  const [testArray, setTestArray] = useRecoilState(TestArray);
  const [reviewNote, setReviewNote] = useRecoilState(ReviewNote);
  const [right1Count, setRight1Count] = useRecoilState(Right1Count);
  const [right2Count, setRight2Count] = useRecoilState(Right2Count);
  const [right3Count, setRight3Count] = useRecoilState(Right3Count);
  const [right4Count, setRight4Count] = useRecoilState(Right4Count);
  const [right5Count, setRight5Count] = useRecoilState(Right5Count);
  const [right6Count, setRight6Count] = useRecoilState(Right6Count);
  // Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    setChoiceArray({
      0: 9,
      1: 9,
      2: 9,
      3: 9,
      4: 9,
      5: 9,
      6: 9,
      7: 9,
      8: 9,
      9: 9,
      10: 9,
      11: 9,
    });
    setTestArray([]);
    setReviewNote([]);
    setCount(0);
    setRight1Count(0);
    setRight2Count(0);
    setRight3Count(0);
    setRight4Count(0);
    setRight5Count(0);
    setRight6Count(0);
  }, []);
  // Î™®ÏùòÍ≥†ÏÇ¨ ÏãúÏûë Ïó¨Î∂Ä - trueÎ©¥ ÏãúÏûë
  const [testStart, setTestStart] = useState(false);
  // Î™®ÏùòÍ≥†ÏÇ¨ Ï¢ÖÎ•ò - Ïã§Ï†Ñ / ÏùºÎ∞ò
  const [testType, setTestType] = useState('');
  // 'Î™®ÏùòÍ≥†ÏÇ¨ ÏãúÏûëÌïòÍ∏∞' Î≤ÑÌäº Î≥¥Ïù¥Í∏∞ Ïó¨Î∂Ä
  const [toggleStartBox, setToggleStartBox] = useState(false);
  // ÏãúÌóòÏúºÎ°ú ÎÑòÏñ¥Í∞ÄÍ∏∞ ÏúÑÌïú progressÎ∞î Î≥¥Ïù¥Í∏∞ Ïó¨Î∂Ä
  const [toggleStart, setToggleStart] = useState(false);
  // Î™®ÏùòÍ≥†ÏÇ¨ Î¨∏Ï†ú
  const [testData, setTestData] = useState([]);
  // Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ dbÎ°ú Î≥¥ÎÇ¥Í∏∞
  const [getResult, setGetResult] = useState(false);

  // console.log(testArray);
  // 'Ï†úÏ∂úÌïòÍ∏∞' Î≤ÑÌäº ÌÅ¥Î¶≠
  const checkAnswers = () => {
    for (var i = 0; i < testData.length; i++) {
      // Ï†ïÎãµ ÎπÑÍµê
      if (testArray[i].choice === testData[i].answer) {
        if (testArray[i].category === 'ÎÑ§Ìä∏ÏõåÌÅ¨') {
          setRight1Count(prev => prev + 1);
        } else if (testArray[i].category === 'Ïö¥ÏòÅÏ≤¥Ï†ú') {
          setRight2Count(prev => prev + 1);
        } else if (testArray[i].category === 'ÏûêÎ£åÍµ¨Ï°∞') {
          setRight3Count(prev => prev + 1);
        } else if (testArray[i].category === 'Í∏∞ÌÉÄ') {
          setRight4Count(prev => prev + 1);
        } else if (testArray[i].category === 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§') {
          setRight5Count(prev => prev + 1);
        } else {
          setRight6Count(prev => prev + 1);
        }
      } else {
        // Ïò§ÎãµÎÖ∏Ìä∏
        setReviewNote(prev => [...prev, testData[i]]);
      }
    }
    setGetResult(true);
  };

  // Î™®ÏùòÍ≥†ÏÇ¨ Î¨∏Ï†ú Í∞ÄÏ†∏Ïò§Í∏∞ - 12Í∞ú
  const getTestData = () => {
    if (testTitle === 'ÏûÖÎ¨∏ÏûêÎ•º ÏúÑÌïú Î¨∏Ï†ú') {
      // console.log('ÏûÖÎ¨∏Ïûê');
      axios
        .get(`${defaultAPI}/cs-service/fixed/mock`, {
          params: {
            examNum: 1,
          },
        })
        .then(res => {
          // console.log(res);
          setTestData(res.data);
        })
        .catch(err => console.error(err));
    } else if (testTitle === 'Ï§ëÍ∏âÏûêÎ•º ÏúÑÌïú Î¨∏Ï†ú') {
      // console.log('Ï§ëÍ∏âÏûê');
      axios
        .get(`${defaultAPI}/cs-service/fixed/mock`, {
          params: {
            examNum: 2,
          },
        })
        .then(res => {
          // console.log(res);
          setTestData(res.data);
        })
        .catch(err => console.error(err));
    } else {
      axios
        .get(`${defaultAPI}/cs-service/test/mock`, {
          params: {
            category: testTitle,
            questionNum: 12,
          },
        })
        .then(res => {
          // console.log(res);
          setTestData(res.data);
        })
        .catch(err => console.error(err));
    }
  };

  // 'Î™®ÏùòÍ≥†ÏÇ¨ ÏãúÏûëÌïòÍ∏∞' Î≤ÑÌäº ÌÅ¥Î¶≠
  const handleStart = () => {
    getTestData();
    setToggleStart(true);

    setTimeout(() => {
      setTestStart(true);
    }, 2000);
  };
  // console.log(testData);

  // 'Ïã§Ï†Ñ Î™®ÏùòÍ≥†ÏÇ¨' Î≤ÑÌäº ÌÅ¥Î¶≠
  const handleActual = () => {
    setTestType('actual');
    setToggleStartBox(true);
  };
  // 'ÏùºÎ∞ò Î™®ÏùòÍ≥†ÏÇ¨' Î≤ÑÌäº ÌÅ¥Î¶≠
  const handleNormal = () => {
    setTestType('normal');
    setToggleStartBox(true);
  };
  const [testResultInfo, setTestResultInfo] = useState({
    id: '',
    right1: 0,
    right2: 0,
    right3: 0,
    right4: 0,
    right5: 0,
    right6: 0,
    total1: 0,
    total2: 0,
    total3: 0,
    total4: 0,
    total5: 0,
    total6: 0,
  });

  // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
  useEffect(() => {
    if (state === 1) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right1: right1Count,
        total1: 12,
      });
    } else if (state === 2) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right2: right2Count,
        total2: 12,
      });
    } else if (state === 3) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right3: right3Count,
        total3: 12,
      });
    } else if (state === 4) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right4: right4Count,
        total4: 12,
      });
    } else if (state === 5) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right5: right5Count,
        total5: 12,
      });
    } else if (state === 6) {
      setTestResultInfo({
        ...testResultInfo,
        id: testTitle,
        right6: right6Count,
        total6: 12,
      });
    } else {
      setTestResultInfo({
        id: testTitle,
        right1: right1Count,
        right2: right2Count,
        right3: right3Count,
        right4: right4Count,
        right5: right5Count,
        right6: right6Count,
        total1: 2,
        total2: 2,
        total3: 2,
        total4: 2,
        total5: 2,
        total6: 2,
      });
    }
  }, [getResult]);

  // ÌûàÌä∏Îßµ Ïπ¥Ïö¥Ìä∏ 1 Ï∂îÍ∞Ä
  const sendHeatmapData = () => {
    axios
      .post(`${defaultAPI}/cs-service/profile/heatmap`, null, {
        headers: { Authorization: token },
      })
      .then(res => {
        // console.log(res);
        navigate(`/CSTestResult/${testTitle}`, {
          state: testResultInfo,
        });
      })
      .catch(err => console.error(err));
  };
  // Ïò§ÎãµÎÖ∏Ìä∏ Î≥¥ÎÇ¥Í∏∞
  const sendReviewData = () => {
    // console.log('üê∏', reviewNote);
    axios
      .post(
        `${defaultAPI}/cs-service/study/problem/wrong`,
        { requestWrongProblems: reviewNote },
        { headers: { Authorization: token } },
        // reviewNote,
        // {
        //   headers: { Authorization: token },
        // },
      )
      .then(res => {
        console.log('üê∏', res);
        // navigate(`/CSTestResult/${testTitle}`, { state: testResultInfo });
      })
      .catch(err => console.error(err));
  };
  // 'Í≤∞Í≥º ÌôïÏù∏ÌïòÍ∏∞' Î≤ÑÌäº ÌÅ¥Î¶≠
  const handleSubmit = () => {
    axios
      .post(`${defaultAPI}/cs-service/test/result`, testResultInfo, {
        headers: { authorization: token },
      })
      .then(res => {
        // console.log(res);
        sendReviewData();
        sendHeatmapData();
      })
      .catch(err => console.error(err));
    // }
  };

  // const getFixedTest = () => {
  //   axios
  //     .get(`${defaultAPI}/cs-service/fixed/mock`, {
  //       params: { examNum: 1 },
  //     })
  //     .then(res => {
  //       console.log('üéÉ', res);
  //       // navigate(`/CSTestResult/${testTitle}`, { state: testResultInfo });
  //     })
  //     .catch(err => console.error(err));
  // };
  // const getReviewData = () => {
  //   axios
  //     .get(`${defaultAPI}/cs-service/study/problem/wrong`, {
  //       headers: { Authorization: token },
  //     })
  //     .then(res => {
  //       console.log('üéÉ', res);
  //       // navigate(`/CSTestResult/${testTitle}`, { state: testResultInfo });
  //     })
  //     .catch(err => console.error(err));
  // };

  // // console.log(testData, testArray);
  // console.log(testData, testArray, testResultInfo);
  // Ï¥àÍ∏∞Ïóê Ïπ¥ÌÖåÍ≥†Î¶¨Í∞í ÎÑ£Ïñ¥ÎëêÍ∏∞
  useEffect(() => {
    for (var i = 0; i < testData.length; i++) {
      setTestArray(prev => [
        ...prev,
        {
          id: i,
          choice: 9,
          category: testData[i].category,
        },
      ]);
    }
  }, [testData]);

  // ÌÉÄÏù¥Î®∏ Î™®Îìú - Ï¢ÖÎ£å ÏãúÍ∞Ñ ÏùºÎã® 3Ï¥à
  const endTime = 3;

  const testHeight = 550 + testData.length * 550;

  return (
    <>
      {!testStart ? (
        <TestDetailWrapper>
          <TestDetailContent>
            <DetailBox>
              {!toggleStartBox && (
                <>
                  <Content>
                    <p style={{ margin: '0' }}>
                      <span style={{ marginRight: '10px' }}>‚úÖ</span>
                      ÏùºÎ∞ò Î™®ÏùòÍ≥†ÏÇ¨ÏôÄ Ïã§Ï†Ñ Î™®ÏùòÍ≥†ÏÇ¨ Ï§ë ÏõêÌïòÏãúÎäî Í≤ÉÏùÑ
                      ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.
                    </p>
                    <p
                      style={{
                        color: '#7f898f',
                        fontSize: '14px',
                      }}
                    >
                      (Ïã§Ï†Ñ Î™®ÏùòÍ≥†ÏÇ¨Îäî ÏãúÍ∞Ñ Ï†úÌïúÏù¥ ÏûàÏúºÎ©∞, ÏãúÌóò Í≤∞Í≥ºÏôÄ Î∂ÑÏÑùÏù¥
                      Ïù¥Î£®Ïñ¥ÏßëÎãàÎã§)
                    </p>
                    <div
                      style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',

                        marginTop: '30px',
                      }}
                    >
                      {testType === 'actual' ? (
                        <TypeButton
                          style={{
                            marginRight: '20px',
                            backgroundColor: '#008ed0',
                            color: '#fff',
                          }}
                          onClick={handleActual}
                        >
                          Ïã§Ï†Ñ Î™®ÏùòÍ≥†ÏÇ¨
                        </TypeButton>
                      ) : (
                        <TypeButton
                          style={{
                            marginRight: '20px',
                          }}
                          onClick={handleActual}
                        >
                          Ïã§Ï†Ñ Î™®ÏùòÍ≥†ÏÇ¨
                        </TypeButton>
                      )}
                      {testType === 'normal' ? (
                        <TypeButton
                          onClick={handleNormal}
                          style={{
                            marginRight: '20px',
                            backgroundColor: '#008ed0',
                            color: '#fff',
                          }}
                        >
                          ÏùºÎ∞ò Î™®ÏùòÍ≥†ÏÇ¨
                        </TypeButton>
                      ) : (
                        <TypeButton onClick={handleNormal}>
                          ÏùºÎ∞ò Î™®ÏùòÍ≥†ÏÇ¨
                        </TypeButton>
                      )}
                    </div>
                  </Content>
                </>
              )}

              {toggleStartBox ? (
                <>
                  {toggleStart ? (
                    <QuestionBox>
                      <div>Î¨∏Ï†úÎ•º ÏÑ†Î≥Ñ Ï§ëÏûÖÎãàÎã§.</div>
                      <div>Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.</div>
                      <Progress />
                    </QuestionBox>
                  ) : (
                    <QuestionBox>
                      <TypeButton onClick={handleStart}>
                        Î™®ÏùòÍ≥†ÏÇ¨ ÏãúÏûëÌïòÍ∏∞
                      </TypeButton>
                    </QuestionBox>
                  )}
                </>
              ) : (
                <></>
              )}
            </DetailBox>
          </TestDetailContent>
        </TestDetailWrapper>
      ) : (
        <>
          {testType === 'actual' ? (
            <TestDetailWrapper style={{ height: `${testHeight}px` }}>
              <TestDetailContent>
                <TimerBox>
                  <SpentTime
                    mm={'00'}
                    ss={`${endTime}`}
                    message={'Î™®ÏùòÍ≥†ÏÇ¨Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'}
                  />
                </TimerBox>
                <TestList>
                  {testData.map((test, idx) => (
                    <Choices key={idx} test={test} idx={idx} />
                  ))}
                  {!getResult && (
                    <SubmitButton
                      style={{ marginTop: '40px' }}
                      // onClick={handleSubmit}
                      onClick={checkAnswers}
                      // onClick={() => navigate(`/CSTestResult/${testTitle}`)}
                    >
                      Ï†úÏ∂úÌïòÍ∏∞
                    </SubmitButton>
                  )}

                  {getResult && (
                    <SubmitButton
                      style={{ marginTop: '40px' }}
                      onClick={handleSubmit}
                    >
                      Í≤∞Í≥º ÌôïÏù∏ÌïòÍ∏∞
                    </SubmitButton>
                  )}
                </TestList>
              </TestDetailContent>
            </TestDetailWrapper>
          ) : (
            <TestDetailWrapper style={{ height: `${testHeight}px` }}>
              <TestDetailContent>
                <TestList>
                  {testData.map((test, idx) => (
                    <Choices key={idx} test={test} idx={idx} />
                  ))}

                  {!getResult && (
                    <SubmitButton
                      style={{ marginTop: '40px' }}
                      // onClick={handleSubmit}
                      onClick={checkAnswers}
                      // onClick={() => navigate(`/CSTestResult/${testTitle}`)}
                    >
                      Ï†úÏ∂úÌïòÍ∏∞
                    </SubmitButton>
                  )}
                  {getResult && (
                    <SubmitButton
                      style={{ marginTop: `40px` }}
                      onClick={handleSubmit}
                    >
                      Í≤∞Í≥º ÌôïÏù∏ÌïòÍ∏∞
                    </SubmitButton>
                  )}
                </TestList>
              </TestDetailContent>
            </TestDetailWrapper>
          )}
        </>
      )}
      {/* <button onClick={sendReviewData}>test</button>
      <button onClick={getFixedTest}>fixedtest</button>
      <button onClick={getReviewData}>getreview</button> */}
    </>
  );
}

export default React.memo(CSTestDetail);
